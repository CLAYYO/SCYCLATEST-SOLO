---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';
import { formatDate, formatDateTime } from '../../../utils';

// Required for dynamic routes in static builds
export async function getStaticPaths() {
  // In a real implementation, you would fetch all event IDs from Supabase
  // For now, we'll provide some sample paths
  return [
    { params: { id: '1' } },
    { params: { id: '2' } },
    { params: { id: '3' } },
  ];
}

// Get the event ID from the URL
const { id } = Astro.params;

// Fetch the specific event
const { data: event } = await supabase
  .from('events')
  .select('*')
  .eq('id', id)
  .single();

// Sample event data for demonstration if no real data
const sampleEvent = {
  id: '1',
  title: 'Spring Racing Series',
  description: 'Join us for the opening races of the 2024 season with multiple classes competing in Cardigan Bay.',
  start_date: '2024-04-15T10:00:00Z',
  end_date: '2024-04-15T16:00:00Z',
  event_type: 'racing',
  location: 'Cardigan Bay',
  max_participants: 50,
  registration_required: true,
  registration_deadline: '2024-04-10T23:59:59Z',
  entry_fee: 25.00,
  is_members_only: false,
  organizer: 'Racing Committee',
  contact_email: 'racing@scyc.co.uk',
  status: 'published'
};

// Use real data if available, otherwise use sample data
const displayEvent = event || sampleEvent;

if (!displayEvent) {
  return Astro.redirect('/events');
}

const startDate = new Date(displayEvent.start_date);
const registrationDeadline = displayEvent.registration_deadline ? new Date(displayEvent.registration_deadline) : null;
const isRegistrationOpen = registrationDeadline ? new Date() < registrationDeadline : true;
const isPastEvent = new Date() > startDate;

// Redirect if registration is not available
if (!displayEvent.registration_required || !isRegistrationOpen || isPastEvent) {
  return Astro.redirect(`/events/${id}`);
}

const eventTypeLabels = {
  racing: 'Racing Event',
  social: 'Social Event',
  training: 'Training & Course',
  meeting: 'Club Meeting',
  maintenance: 'Club Maintenance'
};
---

<Layout title={`Register for ${displayEvent.title} - SCYC Events`}>
  <!-- Breadcrumb -->
  <nav class="bg-gray-50 py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center space-x-2 text-sm text-gray-500">
        <a href="/" class="hover:text-navy-700">Home</a>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href="/events" class="hover:text-navy-700">Events</a>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <a href={`/events/${id}`} class="hover:text-navy-700">{displayEvent.title}</a>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="text-gray-900">Register</span>
      </div>
    </div>
  </nav>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
      <!-- Registration Form -->
      <div class="lg:col-span-2">
        <div class="bg-white shadow-sm rounded-lg">
          <div class="px-6 py-8">
            <h1 class="text-3xl font-serif font-bold text-navy-900 mb-2">
              Event Registration
            </h1>
            <p class="text-gray-600 mb-8">
              Please fill out the form below to register for this event.
            </p>

            <!-- Registration Form -->
            <form id="registration-form" class="space-y-6">
              <!-- Personal Information -->
              <div class="border-b border-gray-200 pb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Personal Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                      First Name *
                    </label>
                    <input
                      type="text"
                      id="first_name"
                      name="first_name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                  
                  <div>
                    <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                      Last Name *
                    </label>
                    <input
                      type="text"
                      id="last_name"
                      name="last_name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                  <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                      Email Address *
                    </label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                  
                  <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                      Phone Number
                    </label>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                </div>
              </div>

              <!-- Membership Information -->
              <div class="border-b border-gray-200 pb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Membership Information
                </h3>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Are you a SCYC member? *
                    </label>
                    <div class="space-y-2">
                      <label class="flex items-center">
                        <input
                          type="radio"
                          name="is_member"
                          value="yes"
                          class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300"
                        />
                        <span class="ml-2 text-sm text-gray-700">Yes, I am a current member</span>
                      </label>
                      <label class="flex items-center">
                        <input
                          type="radio"
                          name="is_member"
                          value="no"
                          class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300"
                        />
                        <span class="ml-2 text-sm text-gray-700">No, I am not a member</span>
                      </label>
                    </div>
                  </div>
                  
                  <div id="member-number-field" class="hidden">
                    <label for="member_number" class="block text-sm font-medium text-gray-700 mb-2">
                      Membership Number
                    </label>
                    <input
                      type="text"
                      id="member_number"
                      name="member_number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                </div>
              </div>

              <!-- Event-Specific Information -->
              {displayEvent.event_type === 'racing' && (
                <div class="border-b border-gray-200 pb-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    Racing Information
                  </h3>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label for="boat_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Boat Name
                      </label>
                      <input
                        type="text"
                        id="boat_name"
                        name="boat_name"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                      />
                    </div>
                    
                    <div>
                      <label for="boat_class" class="block text-sm font-medium text-gray-700 mb-2">
                        Boat Class
                      </label>
                      <select
                        id="boat_class"
                        name="boat_class"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                      >
                        <option value="">Select a class</option>
                        <option value="Windsurfer">Windsurfer</option>
                        <option value="Laser">Laser</option>
                        <option value="Optimist">Optimist</option>
                        <option value="Topper">Topper</option>
                        <option value="RS Feva">RS Feva</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="mt-6">
                    <label for="sail_number" class="block text-sm font-medium text-gray-700 mb-2">
                      Sail Number
                    </label>
                    <input
                      type="text"
                      id="sail_number"
                      name="sail_number"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                  
                  <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Experience Level
                    </label>
                    <div class="space-y-2">
                      <label class="flex items-center">
                        <input
                          type="radio"
                          name="experience_level"
                          value="beginner"
                          class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300"
                        />
                        <span class="ml-2 text-sm text-gray-700">Beginner</span>
                      </label>
                      <label class="flex items-center">
                        <input
                          type="radio"
                          name="experience_level"
                          value="intermediate"
                          class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300"
                        />
                        <span class="ml-2 text-sm text-gray-700">Intermediate</span>
                      </label>
                      <label class="flex items-center">
                        <input
                          type="radio"
                          name="experience_level"
                          value="advanced"
                          class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300"
                        />
                        <span class="ml-2 text-sm text-gray-700">Advanced</span>
                      </label>
                    </div>
                  </div>
                </div>
              )}

              <!-- Emergency Contact -->
              <div class="border-b border-gray-200 pb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Emergency Contact
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="emergency_name" class="block text-sm font-medium text-gray-700 mb-2">
                      Contact Name *
                    </label>
                    <input
                      type="text"
                      id="emergency_name"
                      name="emergency_name"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                  
                  <div>
                    <label for="emergency_phone" class="block text-sm font-medium text-gray-700 mb-2">
                      Contact Phone *
                    </label>
                    <input
                      type="tel"
                      id="emergency_phone"
                      name="emergency_phone"
                      required
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                    />
                  </div>
                </div>
                
                <div class="mt-6">
                  <label for="emergency_relationship" class="block text-sm font-medium text-gray-700 mb-2">
                    Relationship
                  </label>
                  <input
                    type="text"
                    id="emergency_relationship"
                    name="emergency_relationship"
                    placeholder="e.g., Spouse, Parent, Friend"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                  />
                </div>
              </div>

              <!-- Additional Information -->
              <div class="border-b border-gray-200 pb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                  Additional Information
                </h3>
                
                <div>
                  <label for="dietary_requirements" class="block text-sm font-medium text-gray-700 mb-2">
                    Dietary Requirements or Allergies
                  </label>
                  <textarea
                    id="dietary_requirements"
                    name="dietary_requirements"
                    rows="3"
                    placeholder="Please specify any dietary requirements, allergies, or medical conditions we should be aware of"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                  ></textarea>
                </div>
                
                <div class="mt-6">
                  <label for="additional_notes" class="block text-sm font-medium text-gray-700 mb-2">
                    Additional Notes
                  </label>
                  <textarea
                    id="additional_notes"
                    name="additional_notes"
                    rows="3"
                    placeholder="Any additional information or special requests"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-navy-500 focus:border-navy-500"
                  ></textarea>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="pb-6">
                <div class="space-y-4">
                  <label class="flex items-start">
                    <input
                      type="checkbox"
                      name="terms_accepted"
                      required
                      class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300 rounded mt-1"
                    />
                    <span class="ml-2 text-sm text-gray-700">
                      I accept the <a href="/terms" class="text-navy-700 hover:text-navy-900 underline">terms and conditions</a> and understand that participation is at my own risk. *
                    </span>
                  </label>
                  
                  <label class="flex items-start">
                    <input
                      type="checkbox"
                      name="waiver_accepted"
                      required
                      class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300 rounded mt-1"
                    />
                    <span class="ml-2 text-sm text-gray-700">
                      I acknowledge that sailing and water sports involve inherent risks and I participate at my own risk. I release SCYC from any liability. *
                    </span>
                  </label>
                  
                  <label class="flex items-start">
                    <input
                      type="checkbox"
                      name="marketing_consent"
                      class="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300 rounded mt-1"
                    />
                    <span class="ml-2 text-sm text-gray-700">
                      I consent to receiving marketing communications from SCYC about future events and club news.
                    </span>
                  </label>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="flex items-center justify-between pt-6">
                <a href={`/events/${id}`} class="text-gray-600 hover:text-gray-900">
                  ← Back to Event
                </a>
                
                <button
                  type="submit"
                  class="btn-primary"
                  id="submit-button"
                >
                  <span id="submit-text">Complete Registration</span>
                  <span id="submit-loading" class="hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                  </span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Event Summary Sidebar -->
      <div class="mt-8 lg:mt-0">
        <div class="bg-gray-50 rounded-lg p-6 sticky top-6">
          <h3 class="text-lg font-semibold text-navy-900 mb-4">
            Event Summary
          </h3>
          
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-gray-900 mb-1">
                {displayEvent.title}
              </h4>
              <p class="text-sm text-gray-600">
                {eventTypeLabels[displayEvent.event_type] || displayEvent.event_type}
              </p>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center text-sm text-gray-600 mb-2">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                </svg>
                {formatDate(startDate)}
              </div>
              
              <div class="flex items-center text-sm text-gray-600 mb-2">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                </svg>
                {displayEvent.location}
              </div>
              
              {displayEvent.entry_fee > 0 && (
                <div class="flex items-center text-sm text-gray-600">
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
                  </svg>
                  Entry Fee: £{displayEvent.entry_fee.toFixed(2)}
                </div>
              )}
            </div>
            
            {registrationDeadline && (
              <div class="border-t border-gray-200 pt-4">
                <div class="text-sm">
                  <span class="font-medium text-gray-900">Registration Deadline:</span>
                  <div class="text-gray-600 mt-1">
                    {formatDateTime(registrationDeadline)}
                  </div>
                </div>
              </div>
            )}
            
            <div class="border-t border-gray-200 pt-4">
              <div class="text-sm">
                <span class="font-medium text-gray-900">Questions?</span>
                <div class="mt-2 space-y-1">
                  <a href={`mailto:${displayEvent.contact_email}`} class="block text-navy-700 hover:text-navy-900">
                    {displayEvent.contact_email}
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Handle membership radio button changes
  const memberRadios = document.querySelectorAll('input[name="is_member"]');
  const memberNumberField = document.getElementById('member-number-field');
  
  memberRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === 'yes') {
        memberNumberField?.classList.remove('hidden');
      } else {
        memberNumberField?.classList.add('hidden');
      }
    });
  });
  
  // Handle form submission
  const form = document.getElementById('registration-form');
  const submitButton = document.getElementById('submit-button');
  const submitText = document.getElementById('submit-text');
  const submitLoading = document.getElementById('submit-loading');
  
  form?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading state
    submitButton?.setAttribute('disabled', 'true');
    submitText?.classList.add('hidden');
    submitLoading?.classList.remove('hidden');
    
    try {
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Here you would typically send the data to your API
      // For now, we'll simulate a successful submission
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Show success message
      alert('Registration successful! You will receive a confirmation email shortly.');
      
      // Redirect to event page
      window.location.href = `/events/${data.event_id || '1'}`;
      
    } catch (error) {
      console.error('Registration failed:', error);
      alert('Registration failed. Please try again or contact us for assistance.');
      
      // Reset button state
      submitButton?.removeAttribute('disabled');
      submitText?.classList.remove('hidden');
      submitLoading?.classList.add('hidden');
    }
  });
</script>

<style>
  .btn-primary {
    @apply inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-navy-700 hover:bg-navy-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-navy-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed;
  }
</style>