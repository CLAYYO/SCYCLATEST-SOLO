---
import Layout from '../../../layouts/Layout.astro';
import { supabase } from '../../../lib/supabase';
import RacingResults from '../../../components/racing/RacingResults';

// Fetch racing data
const { data: races } = await supabase
  .from('races')
  .select('*')
  .order('race_date', { ascending: true });

const { data: raceResults } = await supabase
  .from('race_results')
  .select(`
    *,
    races!inner(*),
    boats!inner(*),
    members!inner(*)
  `)
  .order('position', { ascending: true });

// Process results for display
const processedResults = [];
const raceMap = new Map();

// Group results by series and process
if (raceResults && races) {
  // Create race lookup
  races.forEach(race => {
    raceMap.set(race.id, race);
  });

  // Group by boat/competitor
  const competitorResults = new Map();
  
  raceResults.forEach(result => {
    const key = `${result.boats.sail_number}-${result.members.name}`;
    
    if (!competitorResults.has(key)) {
      competitorResults.set(key, {
        id: result.id,
        place: 0, // Will be calculated
        division: result.boats.boat_class || 'Open',
        sail_no: result.boats.sail_number,
        name: result.members.name,
        age_group: result.age_group,
        race_scores: [],
        total: 0,
        nett: 0,
        dnc_count: 0
      });
    }
    
    const competitor = competitorResults.get(key);
    competitor.race_scores.push(result.points || 999);
    
    if (result.status === 'DNC' || result.status === 'DNF') {
      competitor.dnc_count++;
    }
  });
  
  // Calculate totals and positions
  competitorResults.forEach((competitor, key) => {
    competitor.total = competitor.race_scores.reduce((sum, score) => sum + score, 0);
    // For nett, remove worst score if more than 3 races
    if (competitor.race_scores.length > 3) {
      const sortedScores = [...competitor.race_scores].sort((a, b) => b - a);
      competitor.nett = competitor.total - sortedScores[0];
    } else {
      competitor.nett = competitor.total;
    }
    processedResults.push(competitor);
  });
  
  // Sort by nett score and assign places
  processedResults.sort((a, b) => a.nett - b.nett);
  processedResults.forEach((result, index) => {
    result.place = index + 1;
  });
}

// Get unique divisions
const divisions = [...new Set(processedResults.map(r => r.division))].sort();

// Sample data for demonstration if no real data
const sampleRaces = [
  { id: '1', name: 'Race 1', date: '2024-08-10', venue: 'Abersoch' },
  { id: '2', name: 'Race 2', date: '2024-08-17', venue: 'Pwllheli' },
  { id: '3', name: 'Race 3', date: '2024-08-24', venue: 'Abersoch' },
  { id: '4', name: 'Race 4', date: '2024-08-31', venue: 'Barmouth' }
];

const sampleResults = [
  {
    id: '1',
    place: 1,
    division: 'LW',
    sail_no: 'GBR 123',
    name: 'John Smith',
    age_group: 'Senior',
    race_scores: [1, 2, 1, 3],
    total: 7,
    nett: 5,
    dnc_count: 0
  },
  {
    id: '2',
    place: 2,
    division: 'LW',
    sail_no: 'GBR 456',
    name: 'Sarah Jones',
    age_group: 'Senior',
    race_scores: [2, 1, 3, 1],
    total: 7,
    nett: 6,
    dnc_count: 0
  },
  {
    id: '3',
    place: 3,
    division: 'LW',
    sail_no: 'GBR 789',
    name: 'Mike Wilson',
    age_group: 'Senior',
    race_scores: [3, 3, 2, 2],
    total: 10,
    nett: 7,
    dnc_count: 0
  },
  {
    id: '4',
    place: 1,
    division: 'HW',
    sail_no: 'GBR 321',
    name: 'David Brown',
    age_group: 'Senior',
    race_scores: [1, 1, 1, 999],
    total: 1002,
    nett: 3,
    dnc_count: 1
  },
  {
    id: '5',
    place: 2,
    division: 'HW',
    sail_no: 'GBR 654',
    name: 'Emma Davis',
    age_group: 'Senior',
    race_scores: [2, 2, 2, 1],
    total: 7,
    nett: 5,
    dnc_count: 0
  }
];

// Use real data if available, otherwise use sample data
const displayRaces = races && races.length > 0 ? races.map(race => ({
  id: race.id,
  name: race.name,
  date: race.race_date,
  venue: race.location || 'SCYC'
})) : sampleRaces;

const displayResults = processedResults.length > 0 ? processedResults : sampleResults;
const displayDivisions = divisions.length > 0 ? divisions : ['LW', 'HW'];
---

<Layout title="Racing Results - SCYC">
  <!-- Page Header -->
  <section class="bg-navy-900 text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-serif font-bold mb-4 text-gold-400">
          Racing Results
        </h1>
        <p class="text-xl text-gray-300 max-w-3xl mx-auto">
          View the latest racing results from SCYC competitions and series
        </p>
      </div>
    </div>
  </section>

  <!-- Navigation Tabs -->
  <section class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex space-x-8" aria-label="Racing sections">
        <a href="/racing/results" class="border-b-2 border-gold-500 py-4 px-1 text-sm font-medium text-gold-600">
          Current Series
        </a>
        <a href="/racing/results/archive" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
          Archive
        </a>
        <a href="/racing/results/championship" class="border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
          Championships
        </a>
      </nav>
    </div>
  </section>

  <!-- Results Content -->
  <section class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Current Series Results -->
      <div class="bg-white rounded-lg shadow-sm p-8">
        <RacingResults 
          client:load
          seriesTitle="WINDSURFER NSW SUMMER SERIES 2024-2025"
          races={displayRaces}
          results={displayResults}
          divisions={displayDivisions}
          lastUpdated={new Date().toISOString()}
          isProvisional={true}
        />
      </div>

      <!-- Additional Series -->
      <div class="mt-12 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="card">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-navy-900 mb-3">
              Spring Series 2024
            </h3>
            <p class="text-gray-600 mb-4">
              Completed series with 8 races across multiple venues.
            </p>
            <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
              <span>8 Races</span>
              <span>45 Competitors</span>
            </div>
            <a href="/racing/results/spring-2024" class="text-navy-700 hover:text-gold-600 font-medium">
              View Results →
            </a>
          </div>
        </div>

        <div class="card">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-navy-900 mb-3">
              Club Championship 2024
            </h3>
            <p class="text-gray-600 mb-4">
              Annual championship series determining club champions.
            </p>
            <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
              <span>12 Races</span>
              <span>62 Competitors</span>
            </div>
            <a href="/racing/results/championship-2024" class="text-navy-700 hover:text-gold-600 font-medium">
              View Results →
            </a>
          </div>
        </div>

        <div class="card">
          <div class="p-6">
            <h3 class="text-xl font-semibold text-navy-900 mb-3">
              Regatta Week 2024
            </h3>
            <p class="text-gray-600 mb-4">
              Annual regatta week featuring multiple classes and divisions.
            </p>
            <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
              <span>5 Races</span>
              <span>78 Competitors</span>
            </div>
            <a href="/racing/results/regatta-2024" class="text-navy-700 hover:text-gold-600 font-medium">
              View Results →
            </a>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="mt-12 bg-navy-900 rounded-lg p-8 text-white">
        <h3 class="text-2xl font-serif font-bold mb-6 text-gold-400">
          Racing Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h4 class="font-semibold mb-3">Race Calendar</h4>
            <p class="text-gray-300 mb-4">
              View upcoming races and events in our racing calendar.
            </p>
            <a href="/racing/calendar" class="text-gold-400 hover:text-gold-300">
              View Calendar →
            </a>
          </div>
          <div>
            <h4 class="font-semibold mb-3">Boat Classes</h4>
            <p class="text-gray-300 mb-4">
              Learn about the different boat classes that race at SCYC.
            </p>
            <a href="/racing/classes" class="text-gold-400 hover:text-gold-300">
              View Classes →
            </a>
          </div>
          <div>
            <h4 class="font-semibold mb-3">Racing Rules</h4>
            <p class="text-gray-300 mb-4">
              Download sailing instructions and racing rules.
            </p>
            <a href="/documents/racing" class="text-gold-400 hover:text-gold-300">
              View Documents →
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  /* Sailwave Results Styling */
  :global(.sailwave-results) {
    border-collapse: collapse;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
  }

  :global(.sailwave-results th),
  :global(.sailwave-results td) {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: center;
  }

  :global(.sailwave-results th) {
    background-color: #1e3a8a;
    color: white;
    font-weight: 600;
  }

  :global(.sailwave-results .titlerow) {
    background-color: #1e3a8a !important;
    color: white;
    font-weight: bold;
  }

  :global(.sailwave-results .summaryrow) {
    background-color: #f3f4f6;
    font-weight: bold;
  }

  :global(.sailwave-results .rank1) {
    background-color: #fef3c7;
    font-weight: bold;
  }

  :global(.sailwave-results .rank2) {
    background-color: #f3f4f6;
    font-weight: bold;
  }

  :global(.sailwave-results .rank3) {
    background-color: #fde68a;
    font-weight: bold;
  }

  :global(.sailwave-results .place-cell) {
    font-weight: bold;
    background-color: #f9fafb;
  }

  :global(.sailwave-results .sail-no) {
    font-family: 'Monaco', 'Courier New', monospace;
    font-weight: bold;
  }

  :global(.sailwave-results .competitor-name) {
    text-align: left;
    font-weight: 500;
  }

  :global(.sailwave-results .score-cell) {
    font-weight: 500;
  }

  :global(.sailwave-results .total-cell),
  :global(.sailwave-results .nett-cell) {
    background-color: #f9fafb;
    font-weight: bold;
  }

  :global(.sailwave-results .race-header) {
    min-width: 80px;
  }

  :global(.racing-results-container) {
    font-family: 'Inter', sans-serif;
  }
</style>